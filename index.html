<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, maximum-scale=3.0">
  <title>Otiv - Portfolio Space</title>
  <link rel="icon" type="image/png" href="./favicon.png">
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&display=swap" rel="stylesheet">
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      overflow: hidden;
      background-color: #0f0f0f;
      background-image: radial-gradient(#222 1px, transparent 1px);
      background-size: 20px 20px;
    }

    .menu-button {
      position: fixed;
      top: 20px;
      left: 20px;
      width: 80px;
      height: 80px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      z-index: 1000;
    }

    .menu-button:hover {
      background: rgba(255, 255, 255, 0.1);
      transform: scale(1.05);
    }

    .sound-wave {
      width: 40px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
    }

    .sound-wave span {
      width: 4px;
      height: 16px;
      background: white;
      border-radius: 2px;
      opacity: 0.8;
      animation: pulse 1.5s infinite alternate;
    }

    .sound-wave span:nth-child(1) { height: 24px; animation-delay: 0s; }
    .sound-wave span:nth-child(2) { height: 16px; animation-delay: 0.1s; }
    .sound-wave span:nth-child(3) { height: 8px; animation-delay: 0.2s; }
    .sound-wave span:nth-child(4) { height: 16px; animation-delay: 0.3s; }
    .sound-wave span:nth-child(5) { height: 24px; animation-delay: 0.4s; }

    @keyframes pulse {
      0% { opacity: 0.5; }
      100% { opacity: 1; }
    }

    .dropdown-menu {
      position: absolute;
      top: 100px;
      left: 20px;
      width: 200px;
      background: rgba(0, 0, 0, 0.9);
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
      opacity: 0;
      visibility: hidden;
      transform: translateY(-10px);
      transition: all 0.3s ease;
      z-index: 1001;
    }

    .menu-button:hover + .dropdown-menu,
    .dropdown-menu:hover {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    .dropdown-menu-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 20px;
    }

    .dropdown-menu-header .sound-wave {
      width: 40px;
      height: 32px;
      opacity: 0.8;
    }

    .dropdown-menu ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .dropdown-menu li {
      margin-bottom: 15px;
    }

    .dropdown-menu a {
      color: #ffffff;
      text-decoration: none;
      font-family: 'Orbitron', sans-serif;
      font-size: 16px;
      letter-spacing: 1px;
      transition: all 0.3s ease;
      position: relative;
      display: block;
    }

    .dropdown-menu a:hover {
      color: #ff0000;
      transform: scale(1.02);
    }

    .dropdown-menu a::after {
      content: '';
      position: absolute;
      bottom: -5px;
      left: 0;
      width: 0;
      height: 2px;
      background: #ff0000;
      transition: width 0.3s ease;
    }

    .dropdown-menu a:hover::after {
      width: 100%;
    }

    .close-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 20px;
      height: 20px;
      background: transparent;
      border: none;
      color: white;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .close-btn:hover {
      transform: rotate(90deg);
      color: #ff0000;
    }

    .workspace {
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      position: relative;
    }

    .canvas {
      position: absolute;
      top: 0;
      left: 0;
      transform-origin: top left;
      transition: transform 0.1s ease;
    }

    .tile {
      border-radius: 12px;
      border: 4px solid transparent;
      transition: transform 0.2s ease, box-shadow 0.3s ease;
      background-color: #111;
      position: absolute;
      cursor: default;
      overflow: hidden;
    }

    .tile:hover {
      box-shadow: 0 0 12px rgba(255, 255, 255, 0.2);
    }

    .tile.dragging {
      transform: scale(1.05) translateY(-5px);
      box-shadow: 0 0 20px rgba(255, 255, 255, 0.3);
    }

    .tile.sound-on {
      border-color: #ff6b6b !important;
      box-shadow: 0 0 15px rgba(255, 107, 107, 0.4);
    }

    .sound-indicator {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 20px;
      height: 20px;
      background: rgba(255, 107, 107, 0.8);
      border-radius: 50%;
      display: none;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      color: white;
      pointer-events: none;
      z-index: 10;
    }

    .tile img,
    .tile video {
      display: block;
      border-radius: 8px;
      pointer-events: none;
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .error-placeholder {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      height: 100%;
      color: #666;
      font-size: 14px;
      text-align: center;
      border-radius: 8px;
      background: #222;
    }

    #loadingOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.95);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      color: #6ecf9f;
      font-family: 'Orbitron', sans-serif;
      font-size: 32px;
      letter-spacing: 4px;
      text-shadow: 0 0 20px rgba(110, 207, 159, 0.7);
      animation: loadingPulse 1.2s ease-in-out infinite;
    }

    @keyframes loadingPulse {
      0%, 100% { opacity: 0.7; transform: scale(1); }
      50% { opacity: 1; transform: scale(1.05); }
    }

    @media screen and (max-width: 768px) {
      body {
        background-size: 15px 15px;
      }

      .menu-button {
        width: 60px;
        height: 60px;
        top: 15px;
        left: 15px;
      }

      .sound-wave {
        width: 30px;
        height: 24px;
        gap: 3px;
      }

      .sound-wave span {
        width: 3px;
        height: 12px;
      }

      .sound-wave span:nth-child(1) { height: 18px; }
      .sound-wave span:nth-child(2) { height: 12px; }
      .sound-wave span:nth-child(3) { height: 6px; }
      .sound-wave span:nth-child(4) { height: 12px; }
      .sound-wave span:nth-child(5) { height: 18px; }

      .dropdown-menu {
        top: 85px;
        left: 15px;
        width: calc(100vw - 60px);
        max-width: 300px;
        padding: 15px;
      }

      .dropdown-menu-header .sound-wave {
        width: 30px;
        height: 24px;
      }

      .dropdown-menu a {
        font-size: 18px;
        padding: 8px 0;
      }

      .dropdown-menu li {
        margin-bottom: 12px;
      }

      .workspace {
        touch-action: pan-x pan-y pinch-zoom;
      }

      .canvas {
        width: 100%;
        min-width: 100vw;
      }

      .tile {
        min-width: 150px !important;
        min-height: 150px !important;
        border-width: 2px;
      }

      .sound-indicator {
        width: 24px;
        height: 24px;
        font-size: 14px;
        top: 5px;
        right: 5px;
      }

      .error-placeholder {
        font-size: 12px;
        padding: 10px;
      }

      .tile {
        cursor: pointer;
      }

      .tile:active {
        transform: scale(0.95);
      }

      .tile img,
      .tile video {
        object-fit: cover;
      }
    }

    @media screen and (max-width: 480px) {
      .menu-button {
        width: 50px;
        height: 50px;
        top: 10px;
        left: 10px;
      }

      .sound-wave {
        width: 25px;
        height: 20px;
        gap: 2px;
      }

      .sound-wave span {
        width: 2px;
        height: 10px;
      }

      .sound-wave span:nth-child(1) { height: 15px; }
      .sound-wave span:nth-child(2) { height: 10px; }
      .sound-wave span:nth-child(3) { height: 5px; }
      .sound-wave span:nth-child(4) { height: 10px; }
      .sound-wave span:nth-child(5) { height: 15px; }

      .dropdown-menu {
        top: 70px;
        left: 10px;
        width: calc(100vw - 40px);
        padding: 12px;
      }

      .tile {
        min-width: 120px !important;
        min-height: 120px !important;
      }

      .sound-indicator {
        width: 20px;
        height: 20px;
        font-size: 12px;
      }
    }

    @media (hover: none) and (pointer: coarse) {
      .menu-button:hover + .dropdown-menu,
      .dropdown-menu:hover {
        opacity: 0;
        visibility: hidden;
        transform: translateY(-10px);
      }

      .menu-button.active + .dropdown-menu,
      .dropdown-menu.active {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
      }

      .tile:hover {
        box-shadow: none;
      }

      .dropdown-menu a:hover {
        color: #ffffff;
        transform: none;
      }

      .dropdown-menu a:hover::after {
        width: 0;
      }
    }
  </style>
</head>
<body>

  <div id="loadingOverlay">LOADING...</div>

  <div class="menu-button" id="menuButton">
    <div class="sound-wave">
      <span></span>
      <span></span>
      <span></span>
      <span></span>
      <span></span>
    </div>
  </div>

  <div class="dropdown-menu" id="menu">
    <div class="dropdown-menu-header">
      <div class="sound-wave">
        <span></span>
        <span></span>
        <span></span>
        <span></span>
        <span></span>
      </div>
    </div>
    <ul>
      <li><a href="./">Home</a></li>
      <li><a href="./portfolio/">Portfolio</a></li>
      <li><a href="./showcase/">Showcase</a></li>
      <li><a href="./contact/">Contatti</a></li>
      <li><a href="./about/">About</a></li>
    </ul>
    <button class="close-btn">✕</button>
  </div>

  <div class="workspace">
    <div class="canvas" id="canvas"></div>
  </div>

  <script>
    const frameColors = ['#6ecf9f', '#8aa9ff', '#d88aff', '#ff8ab3', '#ffd88a'];

    // QUI INSERISCI I TUOI MEDIA - Esempio con percorsi relativi per GitHub
    const works = [
      { type: 'image', src: './images/work1.jpg' },
      { type: 'video', src: './videos/demo1.mp4' },
      { type: 'image', src: './images/work2.jpg' },
      { type: 'video', src: './videos/demo2.mp4' },
      { type: 'image', src: './images/work3.jpg' },
      { type: 'video', src: './videos/demo3.mp4' },
      { type: 'image', src: './images/work4.jpg' },
      { type: 'video', src: './videos/demo4.mp4' },
      // Aggiungi qui i tuoi file con percorsi relativi (./images/ o ./videos/)
    ];

    let audioUnlocked = true;
    const canvas = document.getElementById('canvas');
    let nextX = 40;
    let nextY = 100;
    let maxHeight = 0;
    let isMobile = window.innerWidth <= 768;
    let activeVideo = null;

    const menuButton = document.getElementById('menuButton');
    const menu = document.getElementById('menu');

    menuButton.addEventListener('click', (e) => {
      e.stopPropagation();
      menuButton.classList.toggle('active');
      menu.classList.toggle('active');
    });

    document.querySelector('.close-btn').addEventListener('click', () => {
      menuButton.classList.remove('active');
      menu.classList.remove('active');
    });

    window.addEventListener('resize', () => {
      isMobile = window.innerWidth <= 768;
    });

    const urlParams = new URLSearchParams(window.location.search);
    const v = urlParams.get('v');
    let isEditMode = false;

    if (v === 'edit2024') {
      isEditMode = true;
      setTimeout(() => {
        document.querySelectorAll('.tile').forEach(tile => {
          tile.style.cursor = 'grab';
        });
      }, 1000);
    }

    setTimeout(() => {
      const loadingOverlay = document.getElementById('loadingOverlay');
      if (loadingOverlay) {
        loadingOverlay.style.transition = 'opacity 0.4s ease';
        loadingOverlay.style.opacity = '0';
        setTimeout(() => {
          if (loadingOverlay.parentNode) {
            loadingOverlay.parentNode.removeChild(loadingOverlay);
          }
        }, 400);
      }

      works.forEach((work, index) => {
        const tile = document.createElement('div');
        tile.className = 'tile';
        tile.style.borderColor = frameColors[Math.floor(Math.random() * frameColors.length)];

        let content;

        if (work.type === 'image') {
          content = document.createElement('img');
          content.src = work.src;

          content.onload = function() {
            const aspectRatio = this.naturalWidth / this.naturalHeight;
            const maxWidth = isMobile ? 250 : 400;
            const maxHeight = isMobile ? 400 : 600;

            let width, height;

            if (aspectRatio > 1) {
              width = Math.min(maxWidth, this.naturalWidth * (isMobile ? 0.4 : 0.5));
              height = width / aspectRatio;
            } else {
              height = Math.min(maxHeight, this.naturalHeight * (isMobile ? 0.4 : 0.5));
              width = height * aspectRatio;
            }

            width = Math.max(isMobile ? 150 : 200, width);
            height = Math.max(isMobile ? 150 : 200, height);

            tile.style.width = `${width}px`;
            tile.style.height = `${height}px`;
          };

          content.onerror = function() {
            console.error(`Failed to load image: ${work.src}`);
            tile.style.width = isMobile ? '200px' : '300px';
            tile.style.height = isMobile ? '200px' : '300px';
            this.style.display = 'none';
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-placeholder';
            errorDiv.textContent = `Errore caricamento:\n${work.src}`;
            tile.appendChild(errorDiv);
          };

        } else if (work.type === 'video') {
          content = document.createElement('video');
          content.src = work.src;
          content.autoplay = false;
          content.muted = false;
          content.loop = true;
          content.playsInline = true;

          const soundIndicator = document.createElement('div');
          soundIndicator.className = 'sound-indicator';
          soundIndicator.innerHTML = '🔊';
          tile.appendChild(soundIndicator);

          content.onloadedmetadata = function() {
            const aspectRatio = this.videoWidth / this.videoHeight;
            const maxWidth = isMobile ? 250 : 400;
            const maxHeight = isMobile ? 400 : 600;

            let width, height;

            if (aspectRatio > 1) {
              width = Math.min(maxWidth, this.videoWidth * (isMobile ? 0.25 : 0.3));
              height = width / aspectRatio;
            } else {
              height = Math.min(maxHeight, this.videoHeight * (isMobile ? 0.25 : 0.3));
              width = height * aspectRatio;
            }

            width = Math.max(isMobile ? 150 : 200, width);
            height = Math.max(isMobile ? 150 : 200, height);

            tile.style.width = `${width}px`;
            tile.style.height = `${height}px`;
          };

          if (isMobile) {
            tile.addEventListener('touchstart', (e) => {
              if (activeVideo && activeVideo !== content) {
                activeVideo.pause();
                const prevTile = activeVideo.parentElement;
                prevTile.classList.remove('sound-on');
                const prevIndicator = prevTile.querySelector('.sound-indicator');
                if (prevIndicator) prevIndicator.style.display = 'none';
              }

              if (content.paused) {
                content.play().catch(e => console.log("Playback failed:", e));
                tile.classList.add('sound-on');
                soundIndicator.style.display = 'flex';
                activeVideo = content;
              } else {
                content.pause();
                tile.classList.remove('sound-on');
                soundIndicator.style.display = 'none';
                activeVideo = null;
              }
            });
          } else {
            tile.addEventListener('mouseenter', () => {
              content.play().catch(e => console.log("Playback failed:", e));
              tile.classList.add('sound-on');
              soundIndicator.style.display = 'flex';
            });

            tile.addEventListener('mouseleave', () => {
              content.pause();
              tile.classList.remove('sound-on');
              soundIndicator.style.display = 'none';
            });
          }

          content.onerror = function() {
            console.error(`Failed to load video: ${work.src}`);
            tile.style.width = '300px';
            tile.style.height = '300px';
            this.style.display = 'none';
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-placeholder';
            errorDiv.textContent = `Errore caricamento:\n${work.src}`;
            tile.appendChild(errorDiv);
          };
        }

        tile.appendChild(content);

        if (isMobile) {
          tile.style.width = '200px';
          tile.style.height = '200px';
          tile.style.left = `${20 + (index % 2) * 210}px`;
          tile.style.top = `${120 + Math.floor(index / 2) * 220}px`;
        } else {
          tile.style.width = '300px';
          tile.style.height = '300px';
          tile.style.left = `${nextX}px`;
          tile.style.top = `${nextY}px`;
          nextX += 225;
          maxHeight = Math.max(maxHeight, 350);
          if (nextX > window.innerWidth * 1.2) {
            nextX = 40;
            nextY += maxHeight + 30;
            maxHeight = 0;
          }
        }

        canvas.appendChild(tile);
      });
    }, 500);

    let touchStartX = 0;
    let touchStartY = 0;
    let touchStartTime = 0;

    document.addEventListener('touchstart', (e) => {
      if (!isMobile || e.touches.length !== 1) return;
      touchStartX = e.touches[0].clientX;
      touchStartY = e.touches[0].clientY;
      touchStartTime = Date.now();
    }, { passive: true });

    document.addEventListener('touchmove', (e) => {
      if (!isMobile || !activeVideo || e.touches.length !== 1) return;
      const dx = Math.abs(e.touches[0].clientX - touchStartX);
      const dy = Math.abs(e.touches[0].clientY - touchStartY);
      if (dx > 10 || dy > 10) {
        touchStartTime = 0;
      }
    }, { passive: true });

    document.addEventListener('touchend', (e) => {
      if (!isMobile || !activeVideo || touchStartTime === 0) return;
      const touchDuration = Date.now() - touchStartTime;
      if (touchDuration < 300) {
        const targetTile = e.target.closest('.tile');
        const targetVideo = targetTile ? targetTile.querySelector('video') : null;
        if (targetVideo !== activeVideo) {
          activeVideo.pause();
          const tile = activeVideo.parentElement;
          tile.classList.remove('sound-on');
          const indicator = tile.querySelector('.sound-indicator');
          if (indicator) indicator.style.display = 'none';
          activeVideo = null;
        }
      }
    }, { passive: true });

    document.addEventListener('keydown', (e) => {
      if (isEditMode && (e.key === 's' || e.key === 'S')) {
        e.preventDefault();
        const tiles = document.querySelectorAll('.tile');
        const layout = [];
        tiles.forEach((tile, index) => {
          const item = {
            id: index + 1,
            left: parseFloat(tile.style.left) || 0,
            top: parseFloat(tile.style.top) || 0,
            width: parseFloat(tile.style.width) || 200,
            height: parseFloat(tile.style.height) || 200,
          };
          layout.push(item);
        });
        console.clear();
        console.log('%c 🎨 [OTIV] Layout salvato (' + layout.length + ' elementi):', 
                    'color: #6ecf9f; font-size: 16px; font-weight: bold;');
        console.log(JSON.stringify(layout, null, 2));
      }
    });

    let activeTile = null;
    let offsetX = 0;
    let offsetY = 0;
    let isDraggingCanvas = false;
    let dragStartX = 0;
    let dragStartY = 0;

    document.addEventListener('mousedown', e => {
      const tile = e.target.closest('.tile');
      if (tile && !isMobile && isEditMode) {
        activeTile = tile;
        const rect = tile.getBoundingClientRect();
        offsetX = e.clientX - rect.left;
        offsetY = e.clientY - rect.top;
        tile.classList.add('dragging');
        tile.style.zIndex = 1001;
        e.preventDefault();
      } else if (!isMobile) {
        isDraggingCanvas = true;
        dragStartX = e.clientX;
        dragStartY = e.clientY;
      }
    });

    document.addEventListener('mousemove', e => {
      if (activeTile && !isMobile) {
        const canvasRect = canvas.getBoundingClientRect();
        const newX = (e.clientX - offsetX - canvasRect.left) / canvasScale;
        const newY = (e.clientY - offsetY - canvasRect.top) / canvasScale;
        activeTile.style.left = `${newX}px`;
        activeTile.style.top = `${newY}px`;
      } else if (isDraggingCanvas && !isMobile) {
        const dx = e.clientX - dragStartX;
        const dy = e.clientY - dragStartY;
        canvasX += dx;
        canvasY += dy;
        dragStartX = e.clientX;
        dragStartY = e.clientY;
        updateCanvasTransform();
      }
    });

    document.addEventListener('mouseup', () => {
      if (activeTile && !isMobile) {
        activeTile.classList.remove('dragging');
        activeTile.style.zIndex = 1000;
        activeTile = null;
      }
      isDraggingCanvas = false;
    });

    document.addEventListener('touchstart', e => {
      if (e.touches.length === 1) {
        const touch = e.touches[0];
        const tile = touch.target.closest('.tile');
        if (tile && isEditMode) {
          activeTile = tile;
          const rect = tile.getBoundingClientRect();
          offsetX = touch.clientX - rect.left;
          offsetY = touch.clientY - rect.top;
          tile.classList.add('dragging');
          tile.style.zIndex = 1001;
        } else if (!tile) {
          isDraggingCanvas = true;
          dragStartX = touch.clientX;
          dragStartY = touch.clientY;
        }
      }
    }, { passive: false });

    document.addEventListener('touchmove', e => {
      if (e.touches.length === 1) {
        const touch = e.touches[0];
        if (activeTile && isEditMode) {
          const canvasRect = canvas.getBoundingClientRect();
          const newX = (touch.clientX - offsetX - canvasRect.left) / canvasScale;
          const newY = (touch.clientY - offsetY - canvasRect.top) / canvasScale;
          activeTile.style.left = `${newX}px`;
          activeTile.style.top = `${newY}px`;
        } else if (isDraggingCanvas) {
          const dx = touch.clientX - dragStartX;
          const dy = touch.clientY - dragStartY;
          canvasX += dx;
          canvasY += dy;
          dragStartX = touch.clientX;
          dragStartY = touch.clientY;
          updateCanvasTransform();
        }
      }
    }, { passive: false });

    document.addEventListener('touchend', () => {
      if (activeTile) {
        activeTile.classList.remove('dragging');
        activeTile.style.zIndex = 1000;
        activeTile = null;
      }
      isDraggingCanvas = false;
    });

    let canvasX = 0;
    let canvasY = 0;
    let canvasScale = 1;

    function updateCanvasTransform() {
      canvas.style.transform = `translate(${canvasX}px, ${canvasY}px) scale(${canvasScale})`;
    }

    document.addEventListener('wheel', e => {
      if (isMobile) return;
      e.preventDefault();
      const scaleAmount = e.deltaY > 0 ? 0.975 : 1.05;
      const rect = canvas.getBoundingClientRect();
      const mouseX = e.clientX - rect.left;
      const mouseY = e.clientY - rect.top;
      const oldScale = canvasScale;
      canvasScale *= scaleAmount;
      canvasScale = Math.max(0.5, Math.min(canvasScale, 3));
      const scaleChange = canvasScale / oldScale;
      canvasX = mouseX - (mouseX - canvasX) * scaleChange;
      canvasY = mouseY - (mouseY - canvasY) * scaleChange;
      updateCanvasTransform();
    }, { passive: false });

    let initialDistance = null;
    let initialScale = 1;
    let pinchCenterX = 0;
    let pinchCenterY = 0;

    document.addEventListener('touchstart', e => {
      if (e.touches.length === 2) {
        const touch1 = e.touches[0];
        const touch2 = e.touches[1];
        initialDistance = Math.hypot(touch2.clientX - touch1.clientX, touch2.clientY - touch1.clientY);
        initialScale = canvasScale;

        const centerX = (touch1.clientX + touch2.clientX) / 2;
        const centerY = (touch1.clientY + touch2.clientY) / 2;

        pinchCenterX = (centerX - canvasX) / canvasScale;
        pinchCenterY = (centerY - canvasY) / canvasScale;
      }
    });

    document.addEventListener('touchmove', e => {
      if (e.touches.length === 2 && initialDistance !== null) {
        e.preventDefault();

        const touch1 = e.touches[0];
        const touch2 = e.touches[1];
        const currentDistance = Math.hypot(touch2.clientX - touch1.clientX, touch2.clientY - touch1.clientY);

        const scaleChange = currentDistance / initialDistance;
        const newScale = initialScale * scaleChange;
        canvasScale = Math.max(0.1, Math.min(newScale, 4));

        const centerX = (touch1.clientX + touch2.clientX) / 2;
        const centerY = (touch1.clientY + touch2.clientY) / 2;

        canvasX = centerX - pinchCenterX * canvasScale;
        canvasY = centerY - pinchCenterY * canvasScale;

        updateCanvasTransform();
      }
    });

    document.addEventListener('touchend', () => {
      initialDistance = null;
    });

    updateCanvasTransform();

    document.addEventListener('click', (e) => {
      const menu = document.getElementById('menu');
      const menuButton = document.querySelector('.menu-button');
      if (!menu.contains(e.target) && !menuButton.contains(e.target)) {
        menu.classList.remove('active');
        menuButton.classList.remove('active');
      }
    });

    let lastTouchEnd = 0;
    document.addEventListener('touchend', function (event) {
      const now = (new Date()).getTime();
      if (now - lastTouchEnd <= 300) {
        event.preventDefault();
      }
      lastTouchEnd = now;
    }, false);
  </script>

</body>
</html>
